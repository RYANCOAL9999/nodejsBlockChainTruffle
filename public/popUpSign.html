<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
        window{width:300px; height:150px; }
        body{ background-color: ivory;}
        #canvas{border:1px solid red; margin:0 auto; }

        .wrapper {
            position: relative;
            width: 400px;
            height: 200px;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .signature-pad {
            position: absolute;
            left: 0;
            top: 0;
            width:400px;
            height:200px;
            background-color: white;
        }
        </style>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script>
            var dSign = {
                "chi" :
                {
                    "save-png": "儲存電子簽署",
                    "clear" : "重新簽署"
                },
                "eng" :
                {
                    "save-png": "save digital signature",
                    "clear" : "reset"
                }
            };

            function test()
            {
                var url = new URL(window.location.href);
                var language = url.searchParams.get("language");
                var dsObj = dSign[language];
                for(var key in dsObj)
                {
                    $(`#${key}`).text(dsObj[key]);
                }
            }
        </script>
    </head>
    <body onload="test()">
        <div class="wrapper">
            <canvas id="signature-pad" class="signature-pad" width=400 height=200></canvas>
        </div>      
        <button id="save-png" type="button">儲存電子簽署</button>
        <!-- <button id="save-jpeg" type="button">Save as JPEG</button>
        <button id="save-svg" type="button">Save as SVG</button> -->
        <!-- <button id="undo" type="button">Undo</button> -->
        <button id="clear" type="button">重新簽署</button>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js"></script>
        <script>
            var canvas = document.getElementById('signature-pad');
            // Adjust canvas coordinate space taking into account pixel ratio,
            // to make it look crisp on mobile devices.
            // This also causes canvas to be cleared.
            function resizeCanvas() {
                // When zoomed out to less than 100%, for some very strange reason,
                // some browsers report devicePixelRatio as less than 1
                // and only part of the canvas is cleared then.
                var ratio =  Math.min(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
            }

            window.onresize = resizeCanvas;
            resizeCanvas();

            function SetName(data, felid) {
                if (window.opener != null && !window.opener.closed) {
                    var txtName = window.opener.document.getElementById(`${felid}ID`);
                    txtName.value = data;
                    // var Img = new Image();
                    // Img.src = data;
                    // window.opener.document.getElementById(`${felid}Graphic`).append(Img);

                }
                window.close();
            }

            var signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgb(255, 255, 255)' // necessary for saving image as JPEG; can be removed is only saving as PNG or SVG
            });

            document.getElementById('save-png').addEventListener('click', function () {
                if (signaturePad.isEmpty()) {
                    return alert("Please provide a signature first.");
                }

                var url = new URL(window.location.href);
                var felid = url.searchParams.get("felid");
                                                                 
                var data = signaturePad.toDataURL('image/png');
                SetName(data, felid);
            });

            // document.getElementById('save-jpeg').addEventListener('click', function () {
            //     if (signaturePad.isEmpty()) 
            //     {
            //         return alert("Please provide a signature first.");
            //     }

            //     var data = signaturePad.toDataURL('image/jpeg');
            //     console.log(data);
            //     window.open(data);
            // });

            // document.getElementById('save-svg').addEventListener('click', function () {
            //     if (signaturePad.isEmpty()) {
            //         return alert("Please provide a signature first.");
            //     }
            //     var data = signaturePad.toDataURL('image/svg+xml');
            //     console.log(data);
            //     console.log(atob(data.split(',')[1]));
            //     window.open(data);
            // });

            document.getElementById('clear').addEventListener('click', function () {
                signaturePad.clear();
            });

            // document.getElementById('undo').addEventListener('click', function () {
            //     var data = signaturePad.toData();
            //     if (data) {
            //         data.pop(); // remove the last dot or line
            //         signaturePad.fromData(data);
            //     }
            // });
        </script>
    </body>
</html>
